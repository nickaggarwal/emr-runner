aws emr create-cluster --release-label emr-5.21.0 \
--name CSE-Cluster \
--applications Name=Hive \
--service-role Nexus-EMR-Default-Role \
--region us-east-1 \
--ec2-attributes KeyName=aa-hydra-mts-test-pem,InstanceProfile=Nexus-EMR-Default-Role \
--instance-groups InstanceGroupType=MASTER,InstanceCount=1,InstanceType=m5.xlarge InstanceGroupType=CORE,InstanceCount=2,InstanceType=m5.xlarge \
--emrfs Encryption=ClientSide,ProviderType=KMS,KMSKeyId=alias/a9-sa-tommy-crypto


DROP TABLE IF EXISTS tommy_query_data ;

CREATE EXTERNAL TABLE tommy_query_data (
   first_search_gmt_time  STRING, 
   marketplace_id  INT, 
   first_alias  STRING, 
   site_variant  STRING, 
   user_agent_info_type  STRING, 
   user_agent_id  bigINT, 
   search_type  STRING, 
   is_spam  INT, 
   is_trusted_customer  INT, 
   is_trusted_user  INT, 
   is_spam_or_untrusted  INT, 
   session  STRING, 
   query_group_id  STRING, 
   first_rank_function  STRING, 
   is_prime_customer  INT, 
   legal_entity_id  INT, 
   first_ref_marker  STRING, 
   first_search_domain  STRING, 
   is_first_search_amazon_domain  INT, 
   is_first_search_from_external_ad  INT, 
   session_type  INT, 
   is_recognized_session  INT, 
   is_suspect_session  INT, 
   is_editorial_query_group  INT, 
   is_externally_referred_query_group  INT, 
   first_search_path_info  STRING, 
   first_search_query_STRING  STRING, 
   application_name  STRING, 
   application_version  STRING, 
   operating_system_name  STRING, 
   operating_system_version  STRING, 
   device_type  STRING, 
   device_type_id  STRING, 
   spelling_correction  STRING, 
   country_code  STRING, 
   device_name  STRING, 
   client_ip  STRING, 
   spam_reason  STRING, 
   search_method  STRING, 
   keywords  STRING, 
   is_business_customer  INT, 
   program_region_id  STRING, 
   is_auto_spell_corrected  INT, 
   iss_query_prefix  STRING, 
   iss_alias  STRING, 
   iss_clientside_latency  INT, 
   language  STRING, 
   sle_language_from  STRING, 
   sle_language_to  STRING, 
   sle_mlt_keywords  STRING, 
   server  STRING, 
   is_fresh_customer  INT, 
   is_music_subscription_customer  INT, 
   search_contains_suspect_filter  INT, 
   is_fresh_store  INT, 
   post_tp_keywords  STRING, 
   post_tp_phrasedoc_keywords  STRING, 
   customer_delivery_address  STRING, 
   query_length  INT, 
   seconds_until_first_add  INT, 
   first_browse_node  bigINT, 
   last_search_gmt_time  STRING, 
   last_alias  STRING, 
   last_rank_function  STRING, 
   last_browse_node  STRING, 
   page_depth  INT, 
   last_known_customer_id  STRING, 
   rr_first_click  DOUBLE, 
   rr_first_add  DOUBLE, 
   rr_first_purchase  DOUBLE, 
   rr_first_consume  DOUBLE, 
   first_clicked_asin  STRING, 
   first_added_asin  STRING, 
   first_purchased_asin  STRING, 
   first_consumed_asin  STRING, 
   search_count  INT, 
   click_count  INT, 
   add_count  INT, 
   order_count  INT, 
   paid_order_count  INT, 
   free_order_count  INT, 
   units_ordered  INT, 
   paid_units_ordered  INT, 
   free_units_ordered  INT, 
   max_total_found  INT, 
   max_purchase_price  DOUBLE, 
   ops  DOUBLE, 
   clicked  INT, 
   added  INT, 
   purchased  INT, 
   secondary_search_spelling_corrections_offered  INT, 
   spelling_corrections_offered  INT, 
   aliases  STRING, 
   alias_count  INT, 
   weblabs  STRING, 
   browse_nodes  STRING, 
   browse_node_count  INT, 
   browse_node_ancestries  STRING, 
   active_refinements  STRING, 
   active_refinement_count  INT, 
   max_active_refinement_count  INT, 
   search_page_types  STRING, 
   rank_functions  STRING, 
   rank_function_count  INT, 
   non_first_page_count  INT, 
   sparkle_clicks  INT, 
   sparkle_clicked  INT, 
   consume_count  INT, 
   active_refinement_pickers  STRING, 
   refinement_pickers_shown  STRING, 
   paid_purchased  INT, 
   signpost_clicks  INT, 
   signpost_clicked  INT, 
   whole_page_destination_clicks  INT, 
   whole_page_exploration_actions  INT, 
   whole_page_no_action  INT, 
   borrowed  INT, 
   borrow_count  INT, 
   has_next_query_group  INT, 
   next_qg_search_type  STRING, 
   seconds_until_next_qg  INT, 
   next_qg_keywords  STRING, 
   next_qg_keyword_edit_type  STRING, 
   next_qg_keyword_edit_distance  INT, 
   next_qg_browse_node  STRING, 
   next_qg_refmarker  STRING, 
   next_qg_clicked  INT, 
   abandonments  INT, 
   reformulations  INT, 
   reformulated_to_count  INT, 
   reformulated_to_keywords  STRING, 
   reformulated_to_browse_node  bigINT, 
   reformulated_to_query_group  STRING, 
   search_result_lists  STRING, 
   srp_widget_ids  STRING, 
   search_result_list_count  STRING, 
   first_click_list_name  STRING, 
   sponsored_result_click_count  INT, 
   sponsored_result_add_count  INT, 
   sponsored_result_order_count  INT, 
   sponsored_result_impression_count  INT, 
   sponsored_result_ops  DOUBLE, 
   organic_result_click_count  INT, 
   organic_result_add_count  INT, 
   organic_result_order_count  INT, 
   organic_result_impression_count  INT, 
   organic_result_ops  DOUBLE, 
   sparkle_ad_impression_count  INT, 
   total_impression_count  INT, 
   amabot_impression_slot_names  STRING, 
   amabot_impression_creative_ids  STRING, 
   amabot_impression_slot_count  INT, 
   cross_session_order_count  INT, 
   paid_cross_session_order_count  INT, 
   free_cross_session_order_count  INT, 
   cross_session_units_ordered  INT, 
   paid_cross_session_units_ordered  INT, 
   free_cross_session_units_ordered  INT, 
   cross_session_ops  DOUBLE, 
   iss_explicit_acceptance  INT, 
   iss_explicit_acceptance_position  INT, 
   iss_explicit_accept_on_word_break  INT, 
   iss_explicit_category_acceptance  INT, 
   iss_implicit_acceptance  INT, 
   iss_query_prefix_length  INT, 
   iss_query_prefix_tokens  INT, 
   auto_scoped  INT, 
   scoping_node  STRING, 
   down_session_100_minute_overall_search_count  INT, 
   down_session_100_minute_overall_click_count  INT, 
   down_session_100_minute_overall_add_count  INT, 
   down_session_100_minute_overall_paid_unit_count  INT, 
   down_session_100_minute_overall_ops  DOUBLE, 
   down_session_100_minute_sa_search_count  INT, 
   down_session_100_minute_sa_click_count  INT, 
   down_session_100_minute_sa_add_count  INT, 
   down_session_100_minute_sa_paid_unit_count  INT, 
   down_session_100_minute_sa_ops  DOUBLE, 
   down_session_100_minute_sa_paid_purchase_count  INT, 
   daily_searches_first_alias  DOUBLE, 
   daily_searches_last_alias  DOUBLE, 
   specificity_first_alias  DOUBLE, 
   specificity_last_alias  DOUBLE, 
   spotcp_value  DOUBLE, 
   spotcp_currency_code  STRING, 
   transit_first_record_request_id  STRING
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n'
STORED AS PARQUET
LOCATION  's3://a9-sa-data-tommy-datasets-prod/tommy-query-groups-parquet/tr/20190215' ;


CREATE EXTERNAL TABLE graph_out (last_alias STRING, keywords STRING, cart_adds INT, search_count INT) 
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n'
STORED AS textfile 
LOCATION '/user/hadoop/output';


INSERT INTO TABLE graph_out SELECT last_alias, keywords, sum(add_count), sum(search_count) from tommy_query_data where last_alias is not null and keywords is not null and is_spam = 0  group by last_alias, keywords ;


[
    {
        "Name":"S3DistCp step",
        "Args":["s3-dist-cp","--s3Endpoint=s3.amazonaws.com","--dest=s3a://aahydra-mts-naamazon-test/originator/lifetimeadds/95","--src=hdfs:////95/20190215/"],
        "ActionOnFailure":"CONTINUE",
        "Type":"CUSTOM_JAR",
        "Jar":"command-runner.jar"        
    }
]
